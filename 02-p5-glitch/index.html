<!DOCTYPE html>
<html>

<head>
  <style type="text/css">
    body {
      background: black;
      margin: 0;
      overflow: hidden;
    }
  </style>

  <script src="/content/b6a50f5ba932b0ea7f652d9d28e59eced47bc6f8376c25e02d8b3457bb60ac8fi0"></script>
  <script src="/content/a499bb004988202e0e4e6be6dbe9a8dd28fc9565b5182f78a25cfea7d4ee4c67i0"></script>
  <script src="/content/44740a1f30efb247ef41de3355133e12d6f58ab4dc8a3146648e2249fa9c6a39i0"></script>
  <script>
    const i = '/content/45f869235d71180f0c5dab27331b6b61331e25a57a387308cc9db5d9319d39b9i0';
    let g;

    function calculateFitSize(imgWidth, imgHeight, canvasWidth, canvasHeight) {
      const imgRatio = imgWidth / imgHeight;
      const canvasRatio = canvasWidth / canvasHeight;
      let w, h;

      if (canvasRatio > imgRatio) {
        h = canvasHeight;
        w = h * imgRatio;
      } else {
        w = canvasWidth;
        h = w / imgRatio;
      }

      return { w, h };
    }

    function displayGlitchedImage() {
      const { w, h } = calculateFitSize(g.image.width, g.image.height, width, height);
      image(g.image, width / 2 - w / 2, height / 2 - h / 2, w, h);
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);
      noSmooth();
      frameRate(20);
      g = new Glitch();
      loadImage(i, (img) => g.loadImage(img));
    }

    function draw() {
      applyGlitch();
      displayGlitchedImage();
    }

    function applyGlitch() {
      const rand = Math.floor(random(0, 4));
      g.resetBytes();
      g.randomBytes(rand);
      g.buildImage();
      triggerGlitchSound(rand);

    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }

    // sound


    function initializeGlitchComponents() {
      if (glitchComponentsInitialized) return; // Prevent re-initialization

      noise = new Tone.Noise("pink").start();
      autoFilter = new Tone.AutoFilter({
        frequency: "8n",
        baseFrequency: 200,
        octaves: 8
      }).toDestination().start();
      noise.connect(autoFilter);

      synth = new Tone.Synth().toDestination();

      glitchComponentsInitialized = true;
    }

    // Function to be called in sync with visual glitches
    function triggerGlitchSound(rand) {
      if (!glitchComponentsInitialized) return;

      // // Random note trigger
      // const notes = ["C4", "D4"];
      // const randomNote = notes[Math.floor(Math.random() * notes.length)];
      // synth.triggerAttackRelease(randomNote, "16n");

      // Optionally, adjust autoFilter or noise parameters here for variation
      // autoFilter.frequency.setValueAtTime(Math.random() * 1000 + 500, Tone.now(), Math.random());

      // start/stop for sudden cuts
      if (rand < 3) {
        noise.stop();
      } else {
        noise.start();
      }
    }

    function startBackgroundDrone(frequency) {
      const drone = new Tone.Oscillator({
        frequency,
        type: "sine"
      }).toDestination();
      drone.start();
    }
  </script>
</head>

<body>
  <button id="startAudio">ðŸŽ§ Start Sound!</button>

  <script>
    let glitchComponentsInitialized = false;
    let noise, autoFilter, synth;

    document.getElementById('startAudio').addEventListener('click', async () => {
      await Tone.start();
      document.getElementById('startAudio').style.display = 'none';
      initializeGlitchComponents();
      // startBackgroundDrone("C2");
    });
  </script>

</body>

</html>